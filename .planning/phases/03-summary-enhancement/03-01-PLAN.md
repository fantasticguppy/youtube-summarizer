---
phase: 03-summary-enhancement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/key-points/route.ts
  - src/components/key-points-view.tsx
  - src/components/results-tabs.tsx
  - src/app/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can view key points breakdown in dedicated tab"
    - "Key points are extractive (direct facts, quotes, data) not abstractive (narrative summary)"
    - "Key points stream in real-time while summary also streams"
    - "Key points organized into Main Takeaways, Key Facts, Core Arguments, Action Items sections"
  artifacts:
    - path: "src/app/api/key-points/route.ts"
      provides: "Streaming extractive key points API endpoint"
      exports: ["POST"]
    - path: "src/components/key-points-view.tsx"
      provides: "Key points display component with loading state"
      exports: ["KeyPointsView"]
    - path: "src/components/results-tabs.tsx"
      provides: "Three-column tabbed interface"
      contains: "grid-cols-3"
    - path: "src/app/page.tsx"
      provides: "Parallel streaming orchestration"
      contains: "Promise.all"
  key_links:
    - from: "src/app/page.tsx"
      to: "/api/key-points"
      via: "fetch in parallel with /api/summarize"
      pattern: "fetch.*api/key-points"
    - from: "src/components/results-tabs.tsx"
      to: "src/components/key-points-view.tsx"
      via: "import and render in TabsContent"
      pattern: "KeyPointsView"
    - from: "src/app/page.tsx"
      to: "src/components/results-tabs.tsx"
      via: "keyPoints prop"
      pattern: "keyPoints=\\{keyPoints\\}"
---

<objective>
Add key points extraction feature with parallel streaming alongside existing summary.

Purpose: Users get actionable key points breakdown (extractive: direct facts, quotes, data) distinct from the structured summary (abstractive: narrative rewrite). This addresses requirement SUMM-02.

Output: Working key points tab with real-time streaming, organized into Main Takeaways, Key Facts, Core Arguments, and Action Items sections.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/03-summary-enhancement/03-RESEARCH.md

# Existing patterns to follow
@src/app/api/summarize/route.ts
@src/components/summary-view.tsx
@src/components/results-tabs.tsx
@src/app/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create key-points API route with extractive prompt</name>
  <files>src/app/api/key-points/route.ts</files>
  <action>
Create new API route following the exact pattern from `/api/summarize/route.ts`.

Key differences from summarize route:
1. Temperature: 0 (deterministic, prevents rephrasing) - do NOT specify temperature in the current summarize route, so explicitly add `temperature: 0` here
2. System prompt: Focus on EXTRACTING exact phrases, not summarizing
3. User prompt: Explicit instruction to be extractive, use direct quotes, pull specific facts

System prompt (use exactly):
```
You are an expert at extracting key information from video transcripts. Your task is to identify and list the most important points EXACTLY as stated in the transcript. Do NOT paraphrase or summarize - extract direct facts, claims, and actionable items using the speaker's original wording where possible.
```

User prompt structure:
```
Extract the key points from this transcript of "${videoTitle}".

IMPORTANT: This should be EXTRACTIVE, not abstractive. Pull out specific facts, statistics, quotes, and claims directly from the transcript. Do not rephrase or summarize them.

Format your response EXACTLY as:

## Main Takeaways
[3-5 most important insights - use direct quotes or close paraphrases]

## Key Facts & Data
[Specific numbers, statistics, dates, names, or concrete claims mentioned]

## Core Arguments
[Main positions, recommendations, or assertions the speaker makes]

## Action Items
[Any specific recommendations or next steps mentioned - omit section if none]

---

TRANSCRIPT:
${transcript}
```

Set maxOutputTokens to 1500 (key points should be more concise than full summary).
  </action>
  <verify>
File exists at src/app/api/key-points/route.ts with:
- streamText import from 'ai'
- openai import from '@ai-sdk/openai'
- POST function exported
- temperature: 0 in streamText config
- System prompt mentions "extract" and "exact phrases"
- Returns result.toTextStreamResponse()
  </verify>
  <done>API route exists and follows extractive prompt pattern with temperature=0</done>
</task>

<task type="auto">
  <name>Task 2: Create KeyPointsView component and update ResultsTabs</name>
  <files>src/components/key-points-view.tsx, src/components/results-tabs.tsx</files>
  <action>
**Part A: Create KeyPointsView component**

Create `src/components/key-points-view.tsx` following the EXACT pattern from `summary-view.tsx`:
- Same Card/CardHeader/CardContent structure
- Same loading skeleton pattern
- Same CopyButton in header
- Same formatMarkdown function (copy it - the markdown structure is identical)
- Change title from "Summary" to "Key Points"

The component structure:
```typescript
'use client';

import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/tabs';
import { CopyButton } from './copy-button';
import { Skeleton } from '@/components/ui/skeleton';

interface KeyPointsViewProps {
  keyPoints: string;
  isLoading?: boolean;
}

export function KeyPointsView({ keyPoints, isLoading }: KeyPointsViewProps) {
  // Same pattern as SummaryView - loading skeleton, then Card with formatted content
}
```

Copy the formatMarkdown function from summary-view.tsx - the markdown structure (## headers, bullets, bold) is identical.

**Part B: Update ResultsTabs component**

Modify `src/components/results-tabs.tsx`:

1. Add import for KeyPointsView:
   `import { KeyPointsView } from './key-points-view';`

2. Add keyPoints prop to interface:
   ```typescript
   interface ResultsTabsProps {
     summary: string;
     keyPoints: string;  // ADD THIS
     transcript: string;
     transcriptSource?: TranscriptSource;
     hasSpeakers?: boolean;
     isSummarizing?: boolean;
   }
   ```

3. Add keyPoints to destructuring in function signature

4. Change TabsList from `grid-cols-2` to `grid-cols-3`

5. Add middle tab trigger and content:
   ```tsx
   <TabsTrigger value="keypoints">Key Points</TabsTrigger>

   <TabsContent value="keypoints" className="mt-4">
     <KeyPointsView keyPoints={keyPoints} isLoading={isSummarizing && !keyPoints} />
   </TabsContent>
   ```

Tab order should be: Summary, Key Points, Transcript
  </action>
  <verify>
1. `src/components/key-points-view.tsx` exists with KeyPointsView export
2. `src/components/results-tabs.tsx` has:
   - Import for KeyPointsView
   - keyPoints in interface and props
   - grid-cols-3 in TabsList
   - Three TabsTrigger elements
   - TabsContent for keypoints with KeyPointsView
  </verify>
  <done>KeyPointsView component renders key points with loading state, ResultsTabs shows 3 tabs in correct order</done>
</task>

<task type="auto">
  <name>Task 3: Implement parallel streaming in page.tsx</name>
  <files>src/app/page.tsx</files>
  <action>
Modify `src/app/page.tsx` to add keyPoints state and parallel streaming.

**Step 1: Add keyPoints state**

After the existing state declarations, add:
```typescript
const [keyPoints, setKeyPoints] = useState<string>('');
```

**Step 2: Reset keyPoints in handleSubmit**

In the reset state section (around line 24), add:
```typescript
setKeyPoints('');
```

**Step 3: Replace sequential summarization with parallel streaming**

Replace the current Step 2 (lines 50-88 approximately) with parallel streaming pattern:

```typescript
// Step 2: Stream summarization and key points in parallel
try {
  // Start both fetch requests without awaiting
  const summaryFetch = fetch('/api/summarize', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      transcript: result.transcript,
      videoTitle: result.metadata.title,
    }),
  });

  const keyPointsFetch = fetch('/api/key-points', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      transcript: result.transcript,
      videoTitle: result.metadata.title,
    }),
  });

  // Process both streams in parallel using IIFEs
  await Promise.all([
    (async () => {
      const response = await summaryFetch;
      if (!response.ok) throw new Error('Failed to generate summary');
      const reader = response.body?.getReader();
      const decoder = new TextDecoder();
      if (!reader) throw new Error('No response body for summary');

      let accumulated = '';
      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        const chunk = decoder.decode(value, { stream: true });
        accumulated += chunk;
        setSummary(accumulated);
      }
    })(),
    (async () => {
      const response = await keyPointsFetch;
      if (!response.ok) throw new Error('Failed to generate key points');
      const reader = response.body?.getReader();
      const decoder = new TextDecoder();
      if (!reader) throw new Error('No response body for key points');

      let accumulated = '';
      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        const chunk = decoder.decode(value, { stream: true });
        accumulated += chunk;
        setKeyPoints(accumulated);
      }
    })()
  ]);

  setStatus('complete');
} catch (err) {
  setError(err instanceof Error ? err.message : 'Failed to generate summary');
  setStatus('error');
}
```

**Step 4: Pass keyPoints to ResultsTabs**

Update the ResultsTabs component usage (around line 124) to include keyPoints:
```tsx
<ResultsTabs
  summary={summary}
  keyPoints={keyPoints}
  transcript={transcript}
  transcriptSource={transcriptSource}
  hasSpeakers={hasSpeakers}
  isSummarizing={status === 'summarizing'}
/>
```

**Step 5: Update the conditional render**

Change the condition that shows ResultsTabs from:
```tsx
{(transcript || summary) && (
```
to:
```tsx
{(transcript || summary || keyPoints) && (
```
  </action>
  <verify>
Run `npm run dev` and test with a YouTube URL:
1. Verify no TypeScript errors (npm run build or IDE)
2. Load a video - both Summary and Key Points tabs should populate in parallel
3. Key Points tab shows content with Main Takeaways, Key Facts, etc. headers
4. Content is visibly different from Summary (extractive vs abstractive)
  </verify>
  <done>Both summary and key points stream in parallel, Key Points tab displays extractive content distinct from Summary</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Build check**: `npm run build` completes without errors
2. **Manual test**:
   - Go to http://localhost:3000
   - Paste a YouTube URL (suggest a 5-10 min video for reasonable test)
   - Observe both Summary and Key Points streaming simultaneously
   - Switch between tabs - all three have content
3. **Content distinction check**:
   - Summary should have Overview, Main Points, Key Takeaways sections (narrative)
   - Key Points should have Main Takeaways, Key Facts & Data, Core Arguments sections (extractive)
   - Key Points should contain more direct quotes and specific numbers than Summary
</verification>

<success_criteria>
- User can view key points breakdown in dedicated "Key Points" tab
- Key points content is extractive (direct facts, specific data, quotes) not just reformatted summary
- Both summary and key points stream in real-time simultaneously
- Three-tab interface works: Summary | Key Points | Transcript
- No TypeScript errors, build passes
</success_criteria>

<output>
After completion, create `.planning/phases/03-summary-enhancement/03-01-SUMMARY.md` using the summary template.
</output>
