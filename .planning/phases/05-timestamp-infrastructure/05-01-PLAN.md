---
phase: 05-timestamp-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/index.ts
  - src/lib/db/index.ts
  - src/app/page.tsx
autonomous: true

must_haves:
  truths:
    - "Segments array is stored alongside formatted transcript in history"
    - "Existing history entries work without segments (graceful degradation)"
    - "New video processing saves segments to IndexedDB"
  artifacts:
    - path: "src/types/index.ts"
      provides: "HistoryEntry with optional segments field"
      contains: "segments?: TranscriptSegment[]"
    - path: "src/lib/db/index.ts"
      provides: "Schema v2 with segments field and migration"
      contains: "this.version(2)"
    - path: "src/app/page.tsx"
      provides: "State management for rawSegments"
      contains: "rawSegments"
  key_links:
    - from: "src/app/page.tsx"
      to: "src/lib/db/index.ts"
      via: "saveToHistory call with segments parameter"
      pattern: "saveToHistory.*segments"
---

<objective>
Add segments field to data model and persist timestamp data through the pipeline.

Purpose: Enable downstream timestamp display by preserving raw segment data (with offset/duration) alongside formatted transcript text. Currently `rawSegments` are returned by `processVideo` but discarded - this plan threads them through state and into IndexedDB.

Output:
- HistoryEntry type with optional `segments` field
- Dexie schema v2 with migration
- page.tsx state management for segments
- saveToHistory updated to accept and store segments
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-timestamp-infrastructure/05-RESEARCH.md

@src/types/index.ts
@src/lib/db/index.ts
@src/app/page.tsx
@src/actions/process-video.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add segments to HistoryEntry and update Dexie schema</name>
  <files>
    - src/types/index.ts
    - src/lib/db/index.ts
  </files>
  <action>
1. In `src/types/index.ts`, add optional `segments` field to `HistoryEntry`:
   ```typescript
   segments?: TranscriptSegment[];  // Raw segments with timestamps (for clickable timestamps)
   ```
   Add it after `transcript: string` for logical grouping.

2. In `src/lib/db/index.ts`:
   a. Add schema version 2 with migration:
   ```typescript
   // v2: Add segments field for timestamp support
   this.version(2).stores({
     history: '++id, videoId, processedAt'
     // Note: segments not indexed, just stored
   }).upgrade(tx => {
     // Existing entries won't have segments - no data migration needed
     // UI will gracefully handle undefined segments (no timestamps shown)
     return tx.table('history').toCollection().modify(entry => {
       if (!entry.segments) {
         entry.segments = [];
       }
     });
   });
   ```

   b. Update `saveToHistory` function signature to accept segments:
   ```typescript
   export async function saveToHistory(
     videoId: string,
     url: string,
     metadata: VideoMetadata,
     transcript: string,
     segments: TranscriptSegment[],  // ADD THIS PARAMETER
     transcriptSource: TranscriptSource,
     hasSpeakers: boolean,
     summary: string,
     keyPoints: string
   ): Promise<void>
   ```

   c. Update both the add and update operations to include `segments`:
   - In `db.history.add({...})` add: `segments,`
   - In `db.history.update(existing.id!, {...})` add: `segments,`

Import `TranscriptSegment` from `@/types` at top of file.
  </action>
  <verify>
    - `npm run build` passes (TypeScript compiles)
    - Grep for "segments" in both files shows new field
  </verify>
  <done>
    - HistoryEntry has `segments?: TranscriptSegment[]` field
    - Dexie has version 2 schema with migration
    - saveToHistory accepts segments parameter
  </done>
</task>

<task type="auto">
  <name>Task 2: Thread segments through page.tsx state and history save</name>
  <files>
    - src/app/page.tsx
  </files>
  <action>
1. Add state for rawSegments at top of Home component, near other state:
   ```typescript
   const [rawSegments, setRawSegments] = useState<TranscriptSegment[]>([]);
   ```
   Import `TranscriptSegment` from `@/types`.

2. In `handleSubmit`:
   a. Reset rawSegments in the reset block:
      ```typescript
      setRawSegments([]);
      ```

   b. After successful processVideo result, set rawSegments:
      ```typescript
      setRawSegments(result.rawSegments);
      ```
      (Add this right after `setHasSpeakers(result.hasSpeakers);`)

   c. Update the `saveToHistory` call to pass rawSegments:
      ```typescript
      saveToHistory(
        result.videoId,
        url,
        result.metadata,
        result.transcript,
        result.rawSegments,  // ADD THIS - pass segments to history
        result.transcriptSource,
        result.hasSpeakers,
        finalSummary,
        finalKeyPoints
      );
      ```

3. In `handleSelectHistory`:
   a. Restore segments from history entry (with fallback for old entries):
      ```typescript
      setRawSegments(video.segments || []);
      ```
      (Add this after `setTranscript(video.transcript);`)

Note: rawSegments state will be passed to TranscriptView in Plan 02. For now, we're just ensuring it's tracked and persisted.
  </action>
  <verify>
    - `npm run build` passes
    - Grep for "rawSegments" in page.tsx shows state, setter, and usage
    - Grep for "segments" in saveToHistory call shows parameter being passed
  </verify>
  <done>
    - page.tsx has rawSegments state
    - processVideo result.rawSegments stored in state
    - saveToHistory called with segments parameter
    - handleSelectHistory restores segments from history
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `npm run build` passes without TypeScript errors
2. Start dev server and process a new video - should complete without errors
3. Check browser DevTools > Application > IndexedDB > YouTubeSummarizerDB > history
   - New entries should have `segments` array with objects containing `text`, `offset`, `duration`
4. Refresh page, select video from history - should load without errors
</verification>

<success_criteria>
- [ ] HistoryEntry type includes `segments?: TranscriptSegment[]`
- [ ] Dexie schema is version 2 with migration
- [ ] saveToHistory accepts and stores segments
- [ ] page.tsx maintains rawSegments state
- [ ] New videos save segments to IndexedDB
- [ ] Old history entries load without crashing (empty segments array)
- [ ] Build passes, no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-timestamp-infrastructure/05-01-SUMMARY.md`
</output>
