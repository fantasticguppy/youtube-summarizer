---
phase: 05-timestamp-infrastructure
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/lib/timestamps/index.ts
  - src/components/timestamp-link.tsx
  - src/components/transcript-view.tsx
  - src/components/results-tabs.tsx
  - src/app/page.tsx
  - package.json
autonomous: true

must_haves:
  truths:
    - "User sees timestamps every 30-60 seconds inline in transcript"
    - "Clicking a timestamp opens YouTube at that moment in new tab"
    - "Copy button copies plain text without timestamp markers"
  artifacts:
    - path: "src/lib/timestamps/index.ts"
      provides: "formatTimestamp and insertTimestampMarkers utilities"
      exports: ["formatTimestamp", "insertTimestampMarkers"]
    - path: "src/components/timestamp-link.tsx"
      provides: "Clickable timestamp component"
      exports: ["TimestampLink"]
    - path: "src/components/transcript-view.tsx"
      provides: "Transcript rendering with inline timestamps"
      contains: "TimestampLink"
  key_links:
    - from: "src/components/transcript-view.tsx"
      to: "src/components/timestamp-link.tsx"
      via: "import and render TimestampLink"
      pattern: "import.*TimestampLink"
    - from: "src/components/timestamp-link.tsx"
      to: "YouTube"
      via: "anchor href with &t= parameter"
      pattern: "youtube\\.com.*\\&t="
---

<objective>
Display clickable inline timestamps throughout transcript view.

Purpose: Let users navigate to specific moments in YouTube videos by clicking timestamps embedded in the transcript. Timestamps appear every 30-60 seconds at natural text boundaries.

Output:
- TimestampLink component (clickable, opens YouTube at time)
- Timestamp utility functions (formatting, marker insertion)
- Updated TranscriptView with inline timestamp rendering
- react-string-replace for safe component injection
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-timestamp-infrastructure/05-RESEARCH.md
@.planning/phases/05-timestamp-infrastructure/05-01-SUMMARY.md

@src/types/index.ts
@src/components/transcript-view.tsx
@src/components/results-tabs.tsx
@src/app/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-string-replace and create timestamp utilities</name>
  <files>
    - package.json
    - src/lib/timestamps/index.ts
    - src/components/timestamp-link.tsx
  </files>
  <action>
1. Install react-string-replace:
   ```bash
   npm install react-string-replace
   ```

2. Create `src/lib/timestamps/index.ts` with two functions:

   a. `formatTimestamp(ms: number): string` - converts milliseconds to display format:
   ```typescript
   export function formatTimestamp(ms: number): string {
     const totalSeconds = Math.floor(ms / 1000);
     const hours = Math.floor(totalSeconds / 3600);
     const minutes = Math.floor((totalSeconds % 3600) / 60);
     const seconds = totalSeconds % 60;

     const pad = (n: number) => n.toString().padStart(2, '0');

     if (hours > 0) {
       return `${hours}:${pad(minutes)}:${pad(seconds)}`;
     }
     return `${minutes}:${pad(seconds)}`;
   }
   ```

   b. `insertTimestampMarkers(segments: TranscriptSegment[], intervalMs: number = 30000): string`:
   - Iterate through segments
   - Insert `[TS:offset]` marker before segment when offset exceeds lastMarkerTime + intervalMs
   - Return joined text with markers embedded
   ```typescript
   import { TranscriptSegment } from '@/types';

   export function insertTimestampMarkers(
     segments: TranscriptSegment[],
     intervalMs: number = 30000
   ): string {
     if (!segments.length) return '';

     const result: string[] = [];
     let lastMarkerTime = -intervalMs; // Ensures first segment gets a marker at [0:00]

     for (const segment of segments) {
       if (segment.offset - lastMarkerTime >= intervalMs) {
         result.push(`[TS:${segment.offset}]`);
         lastMarkerTime = segment.offset;
       }
       result.push(segment.text);
     }

     return result.join(' ').replace(/\s+/g, ' ').trim();
   }
   ```

3. Create `src/components/timestamp-link.tsx`:
   ```typescript
   import { formatTimestamp } from '@/lib/timestamps';

   interface TimestampLinkProps {
     videoId: string;
     timeMs: number;
   }

   export function TimestampLink({ videoId, timeMs }: TimestampLinkProps) {
     const seconds = Math.floor(timeMs / 1000);
     const formatted = formatTimestamp(timeMs);
     const url = `https://www.youtube.com/watch?v=${videoId}&t=${seconds}`;

     return (
       <a
         href={url}
         target="_blank"
         rel="noopener noreferrer"
         className="inline-flex items-center px-1.5 py-0.5 mx-1 text-xs font-mono bg-primary/10 text-primary hover:bg-primary/20 rounded transition-colors"
       >
         {formatted}
       </a>
     );
   }
   ```
  </action>
  <verify>
    - `npm run build` passes
    - `src/lib/timestamps/index.ts` exists with both functions
    - `src/components/timestamp-link.tsx` exists
  </verify>
  <done>
    - react-string-replace installed
    - formatTimestamp converts ms to "M:SS" or "H:MM:SS"
    - insertTimestampMarkers adds [TS:offset] markers to text
    - TimestampLink renders clickable YouTube deep link
  </done>
</task>

<task type="auto">
  <name>Task 2: Update TranscriptView to render inline timestamps</name>
  <files>
    - src/components/transcript-view.tsx
    - src/components/results-tabs.tsx
    - src/app/page.tsx
  </files>
  <action>
1. Update `src/components/transcript-view.tsx`:

   a. Add new props for segments and videoId:
   ```typescript
   interface TranscriptViewProps {
     transcript: string;
     segments?: TranscriptSegment[];  // ADD
     videoId?: string;                 // ADD
     source?: TranscriptSource;
     hasSpeakers?: boolean;
   }
   ```
   Import `TranscriptSegment` from `@/types`.

   b. Add imports at top:
   ```typescript
   import reactStringReplace from 'react-string-replace';
   import { TimestampLink } from './timestamp-link';
   import { insertTimestampMarkers } from '@/lib/timestamps';
   ```

   c. Update the component to conditionally render timestamps:
   ```typescript
   export function TranscriptView({
     transcript,
     segments = [],
     videoId,
     source = 'youtube',
     hasSpeakers = false
   }: TranscriptViewProps) {
     // ... existing sourceLabel code ...

     // Determine if we can show timestamps
     const canShowTimestamps = segments.length > 0 && videoId;

     // Build content with or without timestamps
     const renderContent = () => {
       if (!canShowTimestamps) {
         // No segments - render plain text (existing behavior)
         return (
           <div
             className="whitespace-pre-wrap text-sm leading-relaxed"
             dangerouslySetInnerHTML={{
               __html: formatTranscriptHtml(transcript, hasSpeakers)
             }}
           />
         );
       }

       // With segments - inject clickable timestamps
       const textWithMarkers = insertTimestampMarkers(segments, 30000);

       // Replace [TS:offset] markers with TimestampLink components
       let content: React.ReactNode[] | string = textWithMarkers;
       content = reactStringReplace(content, /\[TS:(\d+)\]/g, (match, i) => (
         <TimestampLink
           key={`ts-${match}-${i}`}
           videoId={videoId!}
           timeMs={parseInt(match, 10)}
         />
       ));

       // If hasSpeakers, also convert **Speaker X:** to styled spans
       if (hasSpeakers) {
         content = reactStringReplace(content, /\*\*Speaker ([A-Z]):\*\*/g, (match, i) => (
           <strong key={`speaker-${match}-${i}`} className="text-primary">
             Speaker {match}:
           </strong>
         ));
       }

       return (
         <div className="whitespace-pre-wrap text-sm leading-relaxed">
           {content}
         </div>
       );
     };

     return (
       <Card>
         <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
           <div className="space-y-1">
             <CardTitle className="text-lg font-medium">Full Transcript</CardTitle>
             <p className="text-xs text-muted-foreground">
               Source: {sourceLabel}
               {canShowTimestamps && ' â€¢ Click timestamps to jump to video'}
             </p>
           </div>
           <CopyButton text={transcript} />
         </CardHeader>
         <CardContent>
           <div className="prose prose-sm max-w-none dark:prose-invert">
             {renderContent()}
           </div>
         </CardContent>
       </Card>
     );
   }
   ```

   Note: CopyButton still receives plain `transcript` text (no markers) so copy works correctly.

2. Update `src/components/results-tabs.tsx` to pass segments and videoId:

   a. Add props:
   ```typescript
   interface ResultsTabsProps {
     summary: string;
     keyPoints: string;
     transcript: string;
     segments?: TranscriptSegment[];    // ADD
     videoId?: string;                   // ADD
     transcriptSource?: TranscriptSource;
     hasSpeakers?: boolean;
     isSummarizing?: boolean;
   }
   ```
   Import `TranscriptSegment` from `@/types`.

   b. Destructure new props and pass to TranscriptView:
   ```typescript
   export function ResultsTabs({
     summary,
     keyPoints,
     transcript,
     segments = [],           // ADD
     videoId,                 // ADD
     transcriptSource = 'youtube',
     hasSpeakers = false,
     isSummarizing
   }: ResultsTabsProps) {
     // ... existing code ...
     <TranscriptView
       transcript={transcript}
       segments={segments}     // ADD
       videoId={videoId}       // ADD
       source={transcriptSource}
       hasSpeakers={hasSpeakers}
     />
   ```

3. Update `src/app/page.tsx` to pass segments and videoId to ResultsTabs:

   Find the ResultsTabs render and update:
   ```tsx
   <ResultsTabs
     summary={summary}
     keyPoints={keyPoints}
     transcript={transcript}
     segments={rawSegments}        // ADD
     videoId={currentVideoId || undefined}  // ADD
     transcriptSource={transcriptSource}
     hasSpeakers={hasSpeakers}
     isSummarizing={status === 'summarizing'}
   />
   ```
  </action>
  <verify>
    - `npm run build` passes
    - `npm run dev` - process a video, see timestamps in transcript tab
    - Click a timestamp - opens YouTube at correct time in new tab
    - Copy transcript - no [TS:...] markers in clipboard
  </verify>
  <done>
    - TranscriptView renders inline timestamps when segments available
    - Timestamps appear every ~30 seconds
    - Clicking timestamp opens YouTube at that moment
    - Copy button copies clean text without markers
    - Old history entries (no segments) render without timestamps gracefully
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `npm run build` passes
2. Process a new video:
   - Transcript tab shows clickable timestamps every 30 seconds
   - Timestamps format correctly (0:00, 1:30, 2:15, etc.)
   - Click timestamp -> opens YouTube at that moment
3. Copy transcript -> paste elsewhere -> no timestamp markers
4. Select old video from history (before segments) -> renders without timestamps (no crash)
5. Select new video from history (with segments) -> shows timestamps
</verification>

<success_criteria>
- [ ] react-string-replace installed
- [ ] Timestamp utilities (formatTimestamp, insertTimestampMarkers) work correctly
- [ ] TimestampLink renders clickable YouTube deep links
- [ ] TranscriptView shows inline timestamps when segments available
- [ ] Timestamps appear every ~30 seconds at natural boundaries
- [ ] Clicking timestamp opens YouTube at correct time
- [ ] Copy button copies plain text (no markers)
- [ ] Graceful degradation for entries without segments
- [ ] Build passes, no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-timestamp-infrastructure/05-02-SUMMARY.md`
</output>
