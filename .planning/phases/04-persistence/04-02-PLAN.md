---
phase: 04-persistence
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/components/ui/sheet.tsx
  - src/components/history-panel.tsx
  - src/components/header.tsx
  - src/app/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can click History button in header to open slide-out panel"
    - "History panel shows list of saved videos with thumbnails and titles"
    - "Clicking a video in history restores transcript/summary/keyPoints instantly"
    - "Sheet closes automatically after selecting a video"
    - "User can delete videos from history"
    - "Processed videos are automatically saved when complete"
    - "History persists across page refresh"
  artifacts:
    - path: "src/components/ui/sheet.tsx"
      provides: "shadcn/ui Sheet component"
      contains: "SheetContent"
    - path: "src/components/history-panel.tsx"
      provides: "Slide-out history panel using Sheet"
      exports: ["HistoryPanel"]
    - path: "src/components/header.tsx"
      provides: "App header with title and History button"
      exports: ["Header"]
    - path: "src/app/page.tsx"
      provides: "Integration of history with main app flow"
      contains: "useVideoHistory"
  key_links:
    - from: "src/components/history-panel.tsx"
      to: "src/components/ui/sheet.tsx"
      via: "import Sheet components"
      pattern: "from '@/components/ui/sheet'"
    - from: "src/components/header.tsx"
      to: "src/components/history-panel.tsx"
      via: "render HistoryPanel"
      pattern: "<HistoryPanel"
    - from: "src/app/page.tsx"
      to: "src/hooks/use-video-history.ts"
      via: "useVideoHistory hook call"
      pattern: "useVideoHistory\\(\\)"
    - from: "src/app/page.tsx"
      to: "src/components/header.tsx"
      via: "render Header"
      pattern: "<Header"
---

<objective>
Add slide-out history panel UI using shadcn/ui Sheet, triggered by a History button in the header.

Purpose: Implement the user-facing history interface that allows viewing, selecting, and deleting saved videos. The panel slides in from the right, keeping the main content partially visible.

Output:
- shadcn/ui Sheet component installed
- HistoryPanel component with video list in slide-out
- Header component with app title and History trigger button
- page.tsx integration saving videos on completion and restoring on selection
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/04-persistence/04-RESEARCH.md
@.planning/phases/04-persistence/04-01-SUMMARY.md
@src/app/page.tsx
@src/hooks/use-video-history.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install shadcn/ui Sheet and create HistoryPanel component</name>
  <files>
    - src/components/ui/sheet.tsx
    - src/components/history-panel.tsx
  </files>
  <action>
1. Install shadcn/ui Sheet component:
   ```bash
   npx shadcn@latest add sheet
   ```
   This creates src/components/ui/sheet.tsx with Sheet, SheetContent, SheetHeader, etc.

2. Create src/components/history-panel.tsx:

```typescript
'use client';

import { useState } from 'react';
import {
  Sheet,
  SheetContent,
  SheetHeader,
  SheetTitle,
  SheetTrigger,
} from '@/components/ui/sheet';
import { Button } from '@/components/ui/button';
import { History, Trash2 } from 'lucide-react';
import { Skeleton } from '@/components/ui/skeleton';
import type { SavedVideo } from '@/types';

interface HistoryPanelProps {
  videos: SavedVideo[];
  onSelect: (video: SavedVideo) => void;
  onDelete: (videoId: string) => void;
  isLoading?: boolean;
}

function getRelativeTime(timestamp: number): string {
  const rtf = new Intl.RelativeTimeFormat('en', { numeric: 'auto' });
  const now = Date.now();
  const diff = timestamp - now;
  const diffMinutes = Math.round(diff / 60000);
  const diffHours = Math.round(diff / 3600000);
  const diffDays = Math.round(diff / 86400000);

  if (Math.abs(diffMinutes) < 60) {
    return rtf.format(diffMinutes, 'minute');
  } else if (Math.abs(diffHours) < 24) {
    return rtf.format(diffHours, 'hour');
  } else {
    return rtf.format(diffDays, 'day');
  }
}

export function HistoryPanel({ videos, onSelect, onDelete, isLoading }: HistoryPanelProps) {
  // Controlled state for closing sheet on selection
  const [open, setOpen] = useState(false);

  const handleSelect = (video: SavedVideo) => {
    onSelect(video);
    setOpen(false); // Close sheet after selection
  };

  return (
    <Sheet open={open} onOpenChange={setOpen}>
      <SheetTrigger asChild>
        <Button variant="outline" size="icon" className="relative">
          <History className="h-4 w-4" />
          {videos.length > 0 && (
            <span className="absolute -top-1 -right-1 h-4 w-4 rounded-full bg-primary text-[10px] font-medium text-primary-foreground flex items-center justify-center">
              {videos.length > 99 ? '99+' : videos.length}
            </span>
          )}
        </Button>
      </SheetTrigger>
      <SheetContent side="right" className="w-[400px] sm:w-[540px]">
        <SheetHeader>
          <SheetTitle>History</SheetTitle>
        </SheetHeader>
        <div className="mt-4 space-y-2 overflow-y-auto max-h-[calc(100vh-8rem)]">
          {isLoading ? (
            // Loading skeletons
            <div className="space-y-2">
              {[1, 2, 3].map(i => (
                <Skeleton key={i} className="h-16 w-full" />
              ))}
            </div>
          ) : videos.length === 0 ? (
            <p className="text-muted-foreground text-sm text-center py-8">
              No videos yet. Process a YouTube video to see it here.
            </p>
          ) : (
            videos.map(video => (
              <div
                key={video.videoId}
                className="flex items-center gap-3 p-3 rounded-lg cursor-pointer hover:bg-accent transition-colors"
                onClick={() => handleSelect(video)}
              >
                <img
                  src={video.metadata.thumbnailUrl}
                  alt=""
                  className="w-20 h-12 object-cover rounded shrink-0"
                />
                <div className="flex-1 min-w-0">
                  <p className="font-medium truncate text-sm">{video.metadata.title}</p>
                  <p className="text-xs text-muted-foreground">
                    {video.metadata.authorName} &bull; {getRelativeTime(video.savedAt)}
                  </p>
                </div>
                <Button
                  variant="ghost"
                  size="icon"
                  onClick={(e) => {
                    e.stopPropagation();
                    onDelete(video.videoId);
                  }}
                  className="shrink-0 h-8 w-8"
                >
                  <Trash2 className="h-4 w-4" />
                </Button>
              </div>
            ))
          )}
        </div>
      </SheetContent>
    </Sheet>
  );
}
```

Key patterns:
- Controlled Sheet (open/onOpenChange) for closing on selection
- Badge on trigger button shows count (if > 0)
- Relative time using native Intl.RelativeTimeFormat
- stopPropagation on delete to prevent row click
- Scrollable content area for long lists
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - src/components/ui/sheet.tsx exists (generated by shadcn)
    - src/components/history-panel.tsx exports HistoryPanel
  </verify>
  <done>
    - shadcn/ui Sheet component installed
    - HistoryPanel component with controlled state, video list, delete buttons
    - Sheet closes on video selection
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Header component and integrate history with page.tsx</name>
  <files>
    - src/components/header.tsx
    - src/app/page.tsx
  </files>
  <action>
1. Create src/components/header.tsx:

```typescript
'use client';

import { HistoryPanel } from './history-panel';
import type { SavedVideo } from '@/types';

interface HeaderProps {
  history: SavedVideo[];
  historyLoading: boolean;
  onSelectVideo: (video: SavedVideo) => void;
  onDeleteVideo: (videoId: string) => void;
}

export function Header({ history, historyLoading, onSelectVideo, onDeleteVideo }: HeaderProps) {
  return (
    <header className="flex items-center justify-between">
      <div>
        <h1 className="text-3xl font-bold">YouTube Summarizer</h1>
        <p className="text-muted-foreground">
          Paste a YouTube URL to get a transcript and AI-generated summary
        </p>
      </div>
      <HistoryPanel
        videos={history}
        onSelect={onSelectVideo}
        onDelete={onDeleteVideo}
        isLoading={historyLoading}
      />
    </header>
  );
}
```

2. Update src/app/page.tsx with full history integration:

Add imports at top:
```typescript
import { useVideoHistory } from '@/hooks/use-video-history';
import { Header } from '@/components/header';
import type { SavedVideo } from '@/types';
```

Inside Home component, add after existing useState calls:
```typescript
const { history, isLoading: historyLoading, addVideo, removeVideo } = useVideoHistory();
const [currentVideoId, setCurrentVideoId] = useState<string | null>(null);
```

Modify handleSubmit to save video after successful completion.
Refactor the Promise.all to capture final values:

```typescript
// Inside handleSubmit, replace the existing Promise.all section with:

// Variables to capture accumulated values
let finalSummary = '';
let finalKeyPoints = '';

// Process both streams in parallel using IIFEs
await Promise.all([
  (async () => {
    const response = await summaryFetch;
    if (!response.ok) throw new Error('Failed to generate summary');
    const reader = response.body?.getReader();
    const decoder = new TextDecoder();
    if (!reader) throw new Error('No response body for summary');

    let accumulated = '';
    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      const chunk = decoder.decode(value, { stream: true });
      accumulated += chunk;
      setSummary(accumulated);
    }
    finalSummary = accumulated;
  })(),
  (async () => {
    const response = await keyPointsFetch;
    if (!response.ok) throw new Error('Failed to generate key points');
    const reader = response.body?.getReader();
    const decoder = new TextDecoder();
    if (!reader) throw new Error('No response body for key points');

    let accumulated = '';
    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      const chunk = decoder.decode(value, { stream: true });
      accumulated += chunk;
      setKeyPoints(accumulated);
    }
    finalKeyPoints = accumulated;
  })()
]);

// Save to history after both complete
const savedVideo: SavedVideo = {
  videoId: result.videoId,
  url,
  metadata: result.metadata,
  transcript: result.transcript,
  summary: finalSummary,
  keyPoints: finalKeyPoints,
  transcriptSource: result.transcriptSource,
  hasSpeakers: result.hasSpeakers,
  savedAt: Date.now(),
};
await addVideo(savedVideo);
setCurrentVideoId(result.videoId);
setStatus('complete');
```

Add handlers for history selection/deletion (before the return statement):
```typescript
const handleSelectHistory = useCallback((video: SavedVideo) => {
  // Restore video state without re-processing
  setMetadata(video.metadata);
  setTranscript(video.transcript);
  setSummary(video.summary);
  setKeyPoints(video.keyPoints);
  setTranscriptSource(video.transcriptSource);
  setHasSpeakers(video.hasSpeakers);
  setCurrentVideoId(video.videoId);
  setStatus('complete');
  setError(null);
}, []);

const handleDeleteHistory = useCallback(async (videoId: string) => {
  await removeVideo(videoId);
  // If currently viewing this video, clear the display
  if (currentVideoId === videoId) {
    setMetadata(null);
    setTranscript('');
    setSummary('');
    setKeyPoints('');
    setStatus('idle');
    setCurrentVideoId(null);
  }
}, [removeVideo, currentVideoId]);
```

Update the JSX to replace the existing header section with the new Header component:

Replace:
```typescript
<div className="text-center space-y-2">
  <h1 className="text-3xl font-bold">YouTube Summarizer</h1>
  <p className="text-muted-foreground">
    Paste a YouTube URL to get a transcript and AI-generated summary
  </p>
</div>
```

With:
```typescript
<Header
  history={history}
  historyLoading={historyLoading}
  onSelectVideo={handleSelectHistory}
  onDeleteVideo={handleDeleteHistory}
/>
```

Also update the container classes to allow for the header layout:
```typescript
<div className="container max-w-3xl mx-auto py-8 px-4 space-y-6">
```
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npm run build` succeeds
    - Manual test: Process a video, see History button show count badge
    - Manual test: Click History, see video in list
    - Manual test: Click video in history, restores results, sheet closes
    - Manual test: Refresh page, history persists
    - Manual test: Delete from history works
    - Check DevTools > Application > IndexedDB > keyval-store for data
  </verify>
  <done>
    - Header component with title and History panel trigger
    - Processing a video automatically saves to history on completion
    - Clicking history item instantly restores full state (no re-processing)
    - Sheet closes after selection
    - Delete removes from history and clears display if currently viewing
    - History persists across page refresh
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` - Full build succeeds
2. `npm run dev` - App starts without errors
3. Process a video - Should complete and show badge on History button
4. Click History button - Panel slides in from right with video
5. Click video in history - Restores content instantly, panel closes
6. Refresh page - History persists, badge shows count
7. Delete from history - Item removed, badge updates
8. Process same video again - Updates existing entry, no duplicate
9. No SSR hydration errors in console
</verification>

<success_criteria>
1. shadcn/ui Sheet component installed and working
2. History button visible in header with count badge when videos exist
3. Clicking History opens slide-out panel from right
4. Video list shows thumbnails, titles, authors, relative timestamps
5. Clicking video restores full results instantly (no API calls)
6. Sheet closes automatically after selection
7. Delete button removes video from history
8. Processed videos automatically saved on completion
9. History persists across browser sessions/page refreshes
10. No SSR hydration errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-persistence/04-02-SUMMARY.md`
</output>
